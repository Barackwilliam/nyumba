<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nyumba kwenye Ramani</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        #map { height: 500px; width: 100%; }
    </style>
</head>
<body>

    <h2>Nyumba Zinazopatikana</h2>

    <label for="region">Region:</label>
    <input type="text" id="region">

    <label for="district">District:</label>
    <input type="text" id="district">

    <label for="ward">Ward:</label>
    <input type="text" id="ward">

    <button onclick="loadProperties()">Tafuta</button>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        var map = L.map('map').setView([-6.369028, 34.888822], 6); // Tanzania Coordinates

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        function loadProperties() {
    let region = document.getElementById('region').value;
    let district = document.getElementById('district').value;
    let ward = document.getElementById('ward').value;
    
    // Encode the parameters to handle spaces or special characters
    let url = `/api/properties/?region=${encodeURIComponent(region)}&district=${encodeURIComponent(district)}&ward=${encodeURIComponent(ward)}`;

    console.log("Fetching data from:", url);

    fetch(url)
        .then(response => {
            console.log("Response received:", response);
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            console.log("Data received:", data);

            if (data.length === 0) {
                alert("Hakuna nyumba zilizopatikana kwenye eneo hilo!");
                return;
            }

            // If properties found, center map on the first one
            let firstProperty = data[0];
            if (firstProperty.location && firstProperty.location.lat != null && firstProperty.location.lon != null) {
                let firstLat = firstProperty.location.lat;
                let firstLon = firstProperty.location.lon;
                map.setView([firstLat, firstLon], 12); // Center the map to the first property
            }

            data.forEach(property => {
    if (property.location && property.location.lat && property.location.lon) {
        let lat = property.location.lat;
        let lon = property.location.lon;
        let title = property.title;
        
        L.marker([lat, lon]).addTo(map)
            .bindPopup(`<b>${title}</b><br>${property.region}, ${property.district}, ${property.ward}<br>Price: ${property.price}`);
    } else {
        console.warn("Property does not have latitude/longitude:", property);
    }
});

        })
        .catch(error => console.error("Error fetching properties:", error));
}

    </script>
</body>
</html>
